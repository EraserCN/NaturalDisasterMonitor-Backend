<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç”¨æˆ·ç®¡ç†åå°</title>
    <!-- æ ·å¼åº“ï¼šTailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ¡†æ¶ï¼šVue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen">

    <div id="app" v-cloak>
        
        <!-- ================= ç™»å½•ç•Œé¢ ================= -->
        <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
                <div class="bg-blue-600 p-8 text-center">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto text-white text-2xl mb-4 backdrop-blur-sm">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">ç®¡ç†å‘˜ç™»å½•</h2>
                    <p class="text-blue-100 text-sm mt-1">è¯·è¾“å…¥å‡­è¯ä»¥è®¿é—®ç®¡ç†åå°</p>
                </div>
                
                <form @submit.prevent="handleLogin" class="p-8 space-y-6">
                    <div v-if="loginError" class="bg-red-50 text-red-600 p-3 rounded text-sm text-center border border-red-100">
                        <i class="fas fa-circle-exclamation mr-1"></i> {{ loginError }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">è´¦å·</label>
                        <input v-model="loginForm.username" type="text" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="admin">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç </label>
                        <input v-model="loginForm.password" type="password" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>

                    <button :disabled="loading" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-medium transition shadow-lg shadow-blue-500/30 flex justify-center items-center">
                        <i v-if="loading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ loading ? 'ç™»å½•ä¸­...' : 'ç™» å½•' }}
                    </button>
                </form>
                <div class="bg-slate-50 px-8 py-4 text-center text-xs text-slate-400 border-t border-slate-100">
                    å®‰å…¨è¿æ¥ / Encrypted Connection
                </div>
            </div>
        </div>

        <!-- ================= ç®¡ç†ä¸»ç•Œé¢ ================= -->
        <div v-else class="p-6 max-w-6xl mx-auto">
            
            <!-- å¤´éƒ¨ -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-5 rounded-xl shadow-sm border border-slate-200 gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="bg-blue-600 text-white p-3 rounded-lg flex-shrink-0">
                        <i class="fas fa-users-cog text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">ç”¨æˆ·æ•°æ®åº“ç®¡ç†</h1>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <span class="w-2 h-2 rounded-full" :class="apiStatus ? 'bg-green-500' : 'bg-red-500'"></span>
                            {{ apiStatus ? 'åç«¯è¿æ¥æ­£å¸¸' : 'è¿æ¥å¼‚å¸¸' }}
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button @click="logout" class="px-4 py-2.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 font-medium transition flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡º
                    </button>
                    <button 
                        @click="openModal('add')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium transition shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> æ–°å¢ç”¨æˆ·
                    </button>
                </div>
            </header>

            <!-- é”™è¯¯è¯Šæ–­é¢æ¿ -->
            <div v-if="errorMsg" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-6 shadow-sm">
                <div class="flex items-start justify-between">
                    <div class="flex gap-3">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                        <div>
                            <h3 class="text-red-800 font-bold">æ“ä½œå¤±è´¥</h3>
                            <p class="text-red-700 text-sm mt-1">{{ errorMsg }}</p>
                        </div>
                    </div>
                    <button @click="fetchUsers" class="text-red-500 hover:text-red-700 text-sm font-medium underline">é‡è¯•</button>
                </div>
            </div>

            <!-- è¡¨æ ¼åŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold tracking-wider">
                                <th class="p-4 w-20 text-center">åºå·</th>
                                <th class="p-4 w-1/3">ç”¨æˆ· ID (UUID)</th>
                                <th class="p-4">ç”¨æˆ·å</th>
                                <th class="p-4 text-right">æ“ä½œç®¡ç†</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(user, index) in users" :key="user.id" class="hover:bg-slate-50 transition group">
                                <td class="p-4 text-center text-slate-400 font-mono">{{ index + 1 }}</td>
                                <td class="p-4 font-mono text-xs text-slate-400 select-all">{{ user.id }}</td>
                                <td class="p-4 font-medium text-slate-700 text-lg">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs font-bold text-slate-600">
                                            {{ user.username ? user.username.charAt(0).toUpperCase() : '?' }}
                                        </div>
                                        {{ user.username }}
                                    </div>
                                </td>
                                <td class="p-4 text-right space-x-2">
                                    <button 
                                        @click="openModal('edit', user)" 
                                        class="text-slate-400 hover:text-blue-600 bg-white border border-slate-200 hover:border-blue-200 px-3 py-1.5 rounded-md text-sm transition">
                                        <i class="fas fa-key mr-1"></i> é‡ç½®å¯†ç 
                                    </button>
                                    <button 
                                        @click="confirmDelete(user)" 
                                        class="text-slate-400 hover:text-red-600 bg-white border border-slate-200 hover:border-red-200 px-3 py-1.5 rounded-md text-sm transition">
                                        <i class="fas fa-trash-alt mr-1"></i> åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                            <!-- ç©ºçŠ¶æ€ -->
                            <tr v-if="users.length === 0 && !loading">
                                <td colspan="4" class="p-10 text-center text-slate-400">
                                    <i class="fas fa-inbox text-4xl mb-3 block opacity-30"></i>
                                    æš‚æ— ç”¨æˆ·æ•°æ®
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- åŠ è½½çŠ¶æ€ -->
                <div v-if="loading" class="p-4 text-center text-slate-400 bg-slate-50 border-t border-slate-100">
                    <i class="fas fa-spinner fa-spin mr-2"></i> æ•°æ®åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- ================= å¼¹çª—ï¼šæ–°å¢/ä¿®æ”¹ ================= -->
        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeModal">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 class="font-bold text-lg text-slate-800">
                            {{ modalType === 'add' ? 'æ–°å¢ç”¨æˆ·' : 'é‡ç½®å¯†ç ' }}
                        </h3>
                        <button @click="closeModal" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
                    </div>
                    
                    <form @submit.prevent="submitForm" class="p-6 space-y-4">
                        <div v-if="modalType === 'add'">
                            <label class="block text-sm font-medium text-slate-700 mb-1">ç”¨æˆ·å</label>
                            <input v-model="form.username" type="text" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        
                        <div v-if="modalType === 'edit'">
                            <label class="block text-sm font-medium text-slate-700 mb-1">ç›®æ ‡ç”¨æˆ·</label>
                            <div class="w-full px-4 py-2 rounded-lg bg-slate-100 text-slate-500 border border-slate-200">
                                {{ form.username }}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">
                                {{ modalType === 'add' ? 'åˆå§‹å¯†ç ' : 'è®¾ç½®æ–°å¯†ç ' }}
                            </label>
                            <input v-model="form.password" type="password" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" :placeholder="modalType === 'add' ? 'è®¾ç½®ç™»å½•å¯†ç ' : 'è¾“å…¥æ–°çš„å¯†ç '">
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal" class="flex-1 px-4 py-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 font-medium transition">å–æ¶ˆ</button>
                            <button type="submit" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium transition shadow-lg shadow-blue-500/30">
                                <i class="fas fa-save mr-1"></i> ç¡®è®¤æäº¤
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // åç«¯åœ°å€ 
                const API_BASE = '127.0.0.1:3000'; 

                // çŠ¶æ€å˜é‡
                const isLoggedIn = ref(false);
                const token = ref(localStorage.getItem('admin_token') || '');
                const users = ref([]);
                const loading = ref(false);
                const apiStatus = ref(true);
                const errorMsg = ref('');
                
                // ç™»å½•è¡¨å•
                const loginForm = ref({ username: '', password: '' });
                const loginError = ref('');

                // æ¨¡æ€æ¡†æ•°æ®
                const showModal = ref(false);
                const modalType = ref('add');
                const form = ref({ id: '', username: '', password: '' });

                // ---------------- è¾…åŠ©å‡½æ•° ----------------
                const getAuthHeaders = () => {
                    return {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token.value}` // ğŸ”‘ æºå¸¦ Token
                    };
                };

                const handleAuthError = (status) => {
                    if (status === 401 || status === 403) {
                        logout(); // Token è¿‡æœŸæˆ–æ— æ•ˆï¼Œå¼ºåˆ¶ç™»å‡º
                        alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                };

                // ---------------- ç™»å½•/ç™»å‡º ----------------
                const handleLogin = async () => {
                    loading.value = true;
                    loginError.value = '';
                    try {
                        const res = await fetch(`${API_BASE}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm.value)
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            token.value = data.token;
                            localStorage.setItem('admin_token', data.token); // ä¿å­˜ Token
                            isLoggedIn.value = true;
                            fetchUsers(); // ç™»å½•æˆåŠŸç«‹å³æ‹‰å–æ•°æ®
                        } else {
                            loginError.value = 'è´¦å·æˆ–å¯†ç é”™è¯¯';
                        }
                    } catch (e) {
                        loginError.value = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥';
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('admin_token');
                    isLoggedIn.value = false;
                    loginForm.value = { username: '', password: '' };
                };

                // ---------------- æ•°æ®æ“ä½œ ----------------
                const fetchUsers = async () => {
                    loading.value = true;
                    errorMsg.value = '';
                    try {
                        const res = await fetch(`${API_BASE}/api/users`, {
                            headers: getAuthHeaders()
                        });

                        if (!res.ok) {
                            handleAuthError(res.status);
                            throw new Error(`è¯·æ±‚å¤±è´¥: ${res.status}`);
                        }

                        users.value = await res.json();
                        apiStatus.value = true;
                    } catch (e) {
                        if (isLoggedIn.value) { // åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰æŠ¥é”™
                            errorMsg.value = e.message;
                            apiStatus.value = false;
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                const submitForm = async () => {
                    if (modalType.value === 'add') {
                        // æ–°å¢ç”¨æˆ· (å…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ Tokenï¼Œä½†ä¹Ÿå¯ä»¥å¸¦ä¸Š)
                        try {
                            const res = await fetch(`${API_BASE}/api/register`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    username: form.value.username, 
                                    password: form.value.password 
                                })
                            });
                            
                            if (res.status === 409) return alert('âŒ ç”¨æˆ·åå·²å­˜åœ¨');
                            if (!res.ok) throw new Error('åˆ›å»ºå¤±è´¥');

                            closeModal();
                            alert('âœ… åˆ›å»ºæˆåŠŸ');
                            fetchUsers();
                        } catch (e) { alert(e.message); }
                    } else {
                        // ä¿®æ”¹å¯†ç  (éœ€è¦ Token)
                        try {
                            const res = await fetch(`${API_BASE}/api/users/${form.value.id}`, {
                                method: 'PUT',
                                headers: getAuthHeaders(),
                                body: JSON.stringify({ password: form.value.password })
                            });

                            if (!res.ok) {
                                handleAuthError(res.status);
                                throw new Error('ä¿®æ”¹å¤±è´¥');
                            }

                            closeModal();
                            alert('âœ… å¯†ç å·²é‡ç½®');
                        } catch (e) { alert(e.message); }
                    }
                };

                const confirmDelete = async (user) => {
                    if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${user.username}" å—ï¼Ÿ`)) return;

                    try {
                        const res = await fetch(`${API_BASE}/api/users/${user.id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        
                        if (!res.ok) {
                            handleAuthError(res.status);
                            throw new Error('åˆ é™¤å¤±è´¥');
                        }
                        
                        fetchUsers();
                        alert('âœ… å·²åˆ é™¤');
                    } catch (e) { alert(e.message); }
                };

                // æ¨¡æ€æ¡†é€»è¾‘
                const openModal = (type, user = null) => {
                    modalType.value = type;
                    showModal.value = true;
                    if (type === 'edit' && user) {
                        form.value = { id: user.id, username: user.username, password: '' };
                    } else {
                        form.value = { id: '', username: '', password: '' };
                    }
                };
                const closeModal = () => { showModal.value = false; };

                // åˆå§‹åŒ–
                onMounted(() => {
                    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ Token
                    if (token.value) {
                        isLoggedIn.value = true;
                        fetchUsers();
                    }
                });

                return {
                    isLoggedIn, loginForm, loginError, loading, errorMsg, apiStatus,
                    users, showModal, modalType, form,
                    handleLogin, logout, fetchUsers, submitForm, confirmDelete, openModal, closeModal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
